<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Chaos Draft</title>
  <link rel="stylesheet" type="text/css" href="public/styles/all.css" media="all"/>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js">
  </script>
</head>

<body>
  <script type="text/javascript">
    $.ajaxSetup({
      async: false
    });

    const sets =  ["Legend of Blue Eyes White Dragon", "Metal Raiders", "Magic Ruler", "Pharaoh's Servant", "Labyrinth of Nightmare", "Legacy of Darkness", "Pharaonic Guardian", "Magician's Force", "Dark Crisis", "Invasion of Chaos", "Ancient Sanctuary", "Soul of the Duelist", "Rise of Destiny", "Flaming Eternity", "The Lost Millennium", "Cybernetic Revolution", "Elemental Energy", "Shadow of Infinity", "Enemy of Justice", "Power of the Duelist", "Cyberdark Impact", "Strike of Neos", "Force of the Breaker", "Tactical Evolution", "Gladiator's Assault", "Phantom Darkness", "Light of Destruction", "The Duelist Genesis", "Crossroads of Chaos", "Crimson Crisis", "Raging Battle", "Ancient Prophecy", "Stardust Overdrive", "Absolute Powerforce", "The Shining Darkness", "Duelist Revolution", "Starstrike Blast", "Storm of Ragnarok", "Extreme Victory", "Generation Force", "Photon Shockwave", "Order of Chaos", "Galactic Overlord", "Return of the Duelist", "Abyss Rising", "Cosmo Blazer", "Lord of the Tachyon Galaxy", "Judgment of the Light", "Shadow Specters", "Legacy of the Valiant", "Primal Origin", "Duelist Alliance", "The New Challengers", "Secrets of Eternity", "Crossed Souls", "Clash of Rebellions", "Dimension of Chaos", "Breakers of Shadow", "Shining Victories", "The Dark Illusion", "Invasion: Vengeance", "Raging Tempest", "Maximum Crisis", "Code of the Duelist", "Circuit Break", "Extreme Force", "Flames of Destruction", "Cybernetic Horizon", "Soul Fusion", "Savage Strike", "Dark Neostorm", "Rising Rampage", "Chaos Impact", "Ignition Assault", "Eternity Code", "Rise of the Duelist", "Phantom Rage", "Blazing Vortex", "Lightning Overdrive"];
    const num_of_sets = sets.length;
    var drafted_cards = new Set();
    var number_drafted = 0;
    var chosen_id = null; // The id of the card to be drafted.
    var chosen_card = null; // The card to be drafted.
    var cards_in_pack = new Array();

    class YGO_Card {
      constructor(cardname, id, rarity, set, code, isExtra) {
        this.cardname = cardname;
        this.id = id;
        this.rarity = rarity;
        this.set = set;
        this.code = code;
        this.isExtra = isExtra;
      }
      // TODO
      //get id() {
        //return this.id;
      //}
    }

    // TODO: address tokens
    function get_setlist(setname, rarity){
      var setlist = new Array();
      var total_weight;

      // Change the name to match the format of the json filenames"
      var formatted_setname = setname.toLowerCase().replaceAll(' ', '_')
      .replaceAll("'", "").replaceAll(":", "");

      try {
        var set_json;
        var json_link = "https://ek488.github.io/ygo_limited/public/json_files/set_rarity/"
        .concat(formatted_setname).concat("_").concat(rarity.toLowerCase())
        .concat(".json");

        $.getJSON(json_link, function(data) {
          set_json = data;
        });

        for (card in set_json.data) {
          var code;
          var sjd = set_json.data[card];
          var isExtra = false;
          if (sjd.type == "Fusion Monster" || sjd.type == "Synchro Monster" || 
          sjd.type == "Synchro Tuner Monster" || 
          sjd.type == "Synchro Pendulum Effect Monster" || 
          sjd.type == "XYZ Monster" || 
          sjd.type == "XYZ Pendulum Effect Monster" || 
          sjd.type == "Link Monster" || 
          sjd.type == "Pendulum Effect Fusion Monster") {
            isExtra = true;
          }
          for (s in sjd.card_sets) {
            if (sjd.card_sets[s].set_name == setname) {
              code = sjd.card_sets[s].set_code;
            }
          }
          var ygo_card = new YGO_Card(sjd.name, sjd.id, 
          rarity.replaceAll("_", " "), setname, code, isExtra);

          setlist.push(ygo_card);
        }
      }
      // If the set has no cards of this rarity, return null.
      catch (_) {
        setlist = null;
      }

      return setlist;
    }

    function get_commons(common_setlist, n){
      var pack_cards = new Array();
      for (i = 0; i < n; i++) {
        temp = Math.floor(Math.random() * common_setlist.length);
        pack_card = common_setlist[temp];
        // Reroll the card if it's already in the pack.
        while (pack_cards.includes(pack_card)) {
          temp = Math.floor(Math.random() * common_setlist.length);
          pack_card = common_setlist[temp];
        }
        pack_cards.push(pack_card);
      }
      return pack_cards;
    }

    function get_rare(setname, rarity){
      setlist = get_setlist(setname, rarity);
      return setlist[Math.floor(Math.random() * setlist.length)];
    }

    function get_pack(setname){
      var setlist = new Array();

      var pack_cards = [];
      
      var pos = sets.indexOf(setname);
      
      var common_setlist = get_setlist(setname, "Common");
      var short_print_setlist = get_setlist(setname, "Short_Print");
      var super_short_print_setlist = get_setlist(setname, "Super_Short_Print");
      var temp_common_setlist = common_setlist;
      if (short_print_setlist != null) {
        temp_common_setlist = temp_common_setlist.concat(short_print_setlist);
      }
      if (super_short_print_setlist != null) {
        temp_common_setlist = temp_common_setlist.concat(super_short_print_setlist);
      }

      // booster_pack_old
      if (pos <= 22) {
        r = Math.floor(Math.random() * 1380) + 1;
        // TODO: generalize
        if (r <= 929) {
          console.log("8 commons, 1 rare");
          // 8 Commons
          pack_cards = get_commons(temp_common_setlist, 8);
          // 1 Rare
          pack_cards.push(get_rare(setname, "Rare"));
        }
        else if (r >= 930 && r <= 1205) {
          console.log("7 commons, 1 rare, 1 super rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          pack_cards.push(get_rare(setname, "Rare"));
          // 1 Super Rare
          pack_cards.push(get_rare(setname, "Super_Rare"));
        }
        else if (r >= 1206 && r <= 1320) {
          console.log("7 commons, 1 rare, 1 ultra rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          pack_cards.push(get_rare(setname, "Rare"));
          // 1 Ultra Rare
          pack_cards.push(get_rare(setname, "Ultra_Rare"));
        }
        else {
          console.log("7 commons, 1 rare, 1 secret or ultimate rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          pack_cards.push(get_rare(setname, "Rare"));
          // 1 Secret or Ultimate Rare
          var secret_setlist = get_setlist(setname, "Secret_Rare");
          var ultimate_setlist = get_setlist(setname, "Ultimate_Rare");
          var sr_ur_setlist = new Array();
          if (secret_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(secret_setlist);
          }
          if (ultimate_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(ultimate_setlist);
          }
          var pack_card = sr_ur_setlist[Math.floor(Math.random() * sr_ur_setlist.length)];
        
          // Reroll the ultimate rare if it's the same as the rare.
          while (pack_cards.includes(pack_card)) {
            temp = Math.floor(Math.random() * sr_ur_setlist.length);
            pack_card = sr_ur_setlist[temp];
          }
          pack_cards.push(pack_card);
        }
        return pack_cards;
      }
      // booster_pack_old_with_ghost_rare
      else if (pos >= 23 && pos <= 56) {
        r = Math.floor(Math.random() * 1380) + 1;
        // TODO: generalize
        if (r <= 924) {
          console.log("8 commons, 1 rare");
          // 8 Commons
          pack_cards = get_commons(temp_common_setlist, 8);
          // 1 Rare
          pack_cards.push(get_rare(setname, "Rare"));
        }
        else if (r >= 925 && r <= 1200) {
          console.log("7 commons, 1 rare, 1 super rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          pack_cards.push(get_rare(setname, "Rare"));
          // 1 Super Rare
          pack_cards.push(get_rare(setname, "Super_Rare"));
        }
        else if (r >= 1201 && r <= 1315) {
          console.log("7 commons, 1 rare, 1 ultra rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = get_setlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Ultra Rare
          var ultra_setlist = get_setlist(setname, "Ultra_Rare");
          pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        }
        else if (r >= 1316 && r <= 1375) {
          console.log("7 commons, 1 rare, 1 secret or ultimate rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = get_setlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Secret or Ultimate Rare
          var secret_setlist = get_setlist(setname, "Secret_Rare");
          var ultimate_setlist = get_setlist(setname, "Ultimate_Rare");
          var sr_ur_setlist = new Array();
          if (secret_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(secret_setlist);
          }
          if (ultimate_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(ultimate_setlist);
          }
          pack_cards.push(sr_ur_setlist[Math.floor(Math.random() * sr_ur_setlist.length)]);
        }
        else {
          console.log("7 commons, 1 rare, 1 ghost rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = get_setlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Ghost Rare
          var ghost_setlist = get_setlist(setname, "Ghost_Rare");
          pack_cards.push(ghost_setlist[Math.floor(Math.random() * ghost_setlist.length)]);
        }
        return pack_cards;
      }
      // booster_pack
      else if (pos >= 57 && pos <= 70) {
        r = Math.floor(Math.random() * 576) + 1;
        // TODO: generalize
        if (r <= 432) {
          console.log("7 commons, 1 rare, 1 super rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = get_setlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Super Rare
          var super_setlist = get_setlist(setname, "Super_Rare");
          pack_cards.push(super_setlist[Math.floor(Math.random() * super_setlist.length)]);
        }
        else if (r >= 10 && r <= 11) {
          console.log("7 commons, 1 rare, 1 ultra rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = get_setlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Ultra Rare
          var ultra_setlist = get_setlist(setname, "Ultra_Rare");
          pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        }
        else {
          console.log("7 commons, 1 rare, 1 secret or ultimate rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = get_setlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Secret or Ultimate Rare
          var secret_setlist = get_setlist(setname, "Secret_Rare");
          var ultimate_setlist = get_setlist(setname, "Ultimate_Rare");
          var sr_ur_setlist = new Array();
          if (secret_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(secret_setlist);
          }
          if (ultimate_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(ultimate_setlist);
          }
          pack_cards.push(sr_ur_setlist[Math.floor(Math.random() * sr_ur_setlist.length)]);
        }
        return pack_cards;
      }
      // booster_pack_with_starlight_rare
      else if (pos >= 71 && pos <= 73) {
        r = Math.floor(Math.random() * 576) + 1;
        // TODO: generalize
        if (r <= 432) {
          console.log("7 commons, 1 rare, 1 super rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = get_setlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Super Rare
          var super_setlist = get_setlist(setname, "Super_Rare");
          pack_cards.push(super_setlist[Math.floor(Math.random() * super_setlist.length)]);
        }
        else if (r >= 433 && r <= 528) {
          console.log("7 commons, 1 rare, 1 ultra rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = get_setlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Ultra Rare
          var ultra_setlist = get_setlist(setname, "Ultra_Rare");
          pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        }
        else if (r >= 529 && r <= 575) {
          console.log("7 commons, 1 rare, 1 secret or ultimate rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = get_setlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Secret or Ultimate Rare
          var secret_setlist = get_setlist(setname, "Secret_Rare");
          var ultimate_setlist = get_setlist(setname, "Ultimate_Rare");
          var sr_ur_setlist = new Array();
          if (secret_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(secret_setlist);
          }
          if (ultimate_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(ultimate_setlist);
          }
          pack_cards.push(sr_ur_setlist[Math.floor(Math.random() * sr_ur_setlist.length)]);
        }
        else {
          console.log("7 commons, 1 rare, 1 starlight rare");
          // 7 Commons
          pack_cards = get_commons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = get_setlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Starlight Rare
          var starlight_setlist = get_setlist(setname, "Starlight_Rare");
          pack_cards.push(starlight_setlist[Math.floor(Math.random() * starlight_setlist.length)]);
        }
        return pack_cards;
      }
      // booster_pack_without_rare_with_starlight_rare
      else { //if (pos >= 74 && pos <= 77) {
        r = Math.floor(Math.random() * 576) + 1;
        // TODO: generalize
        if (r <= 432) {
          console.log("8 commons, 1 super rare");
          // 8 Commons
          pack_cards = get_commons(temp_common_setlist, 8);
          // 1 Super Rare
          var super_setlist = get_setlist(setname, "Super_Rare");
          pack_cards.push(super_setlist[Math.floor(Math.random() * super_setlist.length)]);
        }
        else if (r >= 433 && r <= 528) {
          console.log("8 commons, 1 ultra rare");
          // 8 Commons
          pack_cards = get_commons(temp_common_setlist, 8);
          // 1 Ultra Rare
          var ultra_setlist = get_setlist(setname, "Ultra_Rare");
          pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        }
        else if (r >= 529 && r <= 575) {
          console.log("8 commons, 1 secret or ultimate rare");
          // 8 Commons
          pack_cards = get_commons(temp_common_setlist, 8);
          // 1 Secret or Ultimate Rare
          var secret_setlist = get_setlist(setname, "Secret_Rare");
          var ultimate_setlist = get_setlist(setname, "Ultimate_Rare");
          var sr_ur_setlist = new Array();
          if (secret_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(secret_setlist);
          }
          if (ultimate_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(ultimate_setlist);
          }
          pack_cards.push(sr_ur_setlist[Math.floor(Math.random() * sr_ur_setlist.length)]);
        }
        else {
          console.log("8 commons, 1 starlight rare");
          // 8 Commons
          pack_cards = get_commons(temp_common_setlist, 8);
          // 1 Starlight Rare
          var starlight_setlist = get_setlist(setname, "Starlight_Rare");
          pack_cards.push(starlight_setlist[Math.floor(Math.random() * starlight_setlist.length)]);
        }
        return pack_cards;
      }
    }

    function display_card_image(id, is_pack_card=false){
      //var rarity = document.createElement("P");
      //rarity.setAttribute("class", "pack");
      //rarity.innerHTML = "Rare"
      //var span = document.createElement("SPAN");
      //span.setAttribute("class", "pack");
      //span.setAttribute("id", "span".concat(id));
      //document.body.insertBefore(span, document.getElementById("brk"));
      //document.getElementById("pack").appendChild(span);

      var x = document.createElement("IMG");
      x.setAttribute("src", "public/images/card_images/".concat(id).concat(".jpg"));
      x.setAttribute("alt", id);
      if (is_pack_card) {
        x.setAttribute("height", 312);
        x.setAttribute("width", 210);
        x.setAttribute("class", "pack");
        x.setAttribute("id", id);
        x.setAttribute("onclick", "choose_card('".concat(String(id)).concat("')"));
        document.getElementById("pack").appendChild(x);
        //span.appendChild(rarity);
        //document.body.insertBefore(x, document.getElementById("break"));
      }
      else {
        x.setAttribute("height", 156);
        x.setAttribute("width", 105);
        document.body.insertBefore(x, document.getElementById("download_break"));
      }
    }

    // Show a border around the last selected card in the pack.
    // TODO: have border cover image
    function choose_card(id){
      // Remove the border from all cards in the pack.
      for (pack_card_img of document.getElementsByClassName("pack")) {
        pack_card_img.style.border = "0px";
        pack_card_img.style.height = "312px";
        pack_card_img.style.width = "210px";
      }

      // TODO: remove chosen_id, replace with chosen_card.id
      // If the clicked card had a border already, don't add a border.
      if (chosen_id != id) {
        chosen_id = id;
        for (card in cards_in_pack) {
          if (cards_in_pack[card].id == id) {
            chosen_card = cards_in_pack[card];
          }
        }

        document.getElementById(id).style.border = "8px solid green";
        document.getElementById(id).style.height = "296px";
        document.getElementById(id).style.width = "194px";
      }
      else {
        chosen_id = null;
        chosen_card = null;
      } 
    }

    // TODO: change hidden to display: none
    function draft(){
      if (chosen_id != null) {
        // Update number of cards drafted
        number_drafted++;
        document.getElementById("setHeader").innerHTML = sets[number_drafted];
        document.getElementById("deckHeader").innerHTML = "Drafted Cards (".concat(number_drafted.toString()).concat("/").concat(num_of_sets).concat(")");

        drafted_cards.add(chosen_card);
        chosen_card = null;
        display_card_image(chosen_id);
        chosen_id = null;

        for (pack_card_img of document.getElementsByClassName("pack")) {
          pack_card_img.setAttribute("hidden", "");
        }

        if (number_drafted < num_of_sets) {
          cards_in_pack = get_pack(sets[number_drafted]);
          for (pack_card of cards_in_pack) {
            display_card_image(pack_card.id, true);
          }
        }
      }
    }
    
    function download_ydk(){
      var deck_cards = Array.from(drafted_cards);
      var ydk = "#created by ...\n#main"
      var extra = ""

      for (card in deck_cards) {
        if (!deck_cards[card].isExtra) {
          ydk = ydk.concat("\n").concat(deck_cards[card].id);
        }
        else {
          extra = extra.concat("\n").concat(deck_cards[card].id);
        }
      }
      var text = ydk.concat("\n#extra").concat(extra);

      var ydk_download = document.createElement("a");
      ydk_download.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text))
      ydk_download.setAttribute('download', "chaos.ydk")
      ydk_download.style.display = 'none';
      document.body.appendChild(ydk_download);

      ydk_download.click();
    }

    function download_csv_collection(){
      const rows = [
        ["cardname", "cardq", "cardid", "cardrarity", "cardcondition", "card_edition", "cardset", "cardcode"],
        //["name2", "city2", "more info"]
      ];
      var deck_cards = Array.from(drafted_cards);

      for (card_number in deck_cards){
        card = deck_cards[card_number];
        var cardname = card.cardname;
        // If CARDNAME has a comma, surround CARDNAME with quotation marks
        if (cardname.includes(",")) {
          cardname = '"'.concat(cardname).concat('"');
        }
        rows.push([cardname, "1", card.id, card.rarity, "M", "Unlimited", card.set, card.code])
      }

      let csvContent = "data:text/csv;charset=utf-8,";
      
      rows.forEach(function(rowArray) {
        let row = rowArray.join(",");
        csvContent += row + "\r\n";
      });

      var encodedUri = encodeURI(csvContent);
      var link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      link.setAttribute("download", "chaos_collection.csv");
      document.body.appendChild(link);
      
      link.click();
    };
  </script>

  <h1 id="setHeader">Legend of Blue Eyes White Dragon</h1>
  <div id="pack"></div>

  <br id="break"></br>
  <div style="text-align: center;">
    <button id="draftButton" type="button" onclick="draft()">Draft Selected Card</button>
  </div>
  <h1 id="deckHeader">Drafted Cards (0/<script>document.write(num_of_sets)</script>)</h1>
  <br id="download_break"></br>
  <button type="button" onclick="download_ydk()">Download .ydk file</button>
  <button type="button" onclick="download_csv_collection()">Download YGOPRODeck Collection .csv file</button>
  <script>
    cards_in_pack = get_pack(sets[number_drafted]);
    for (pack_card of cards_in_pack) {
      display_card_image(pack_card.id, true);
    }
  </script>
  <h2>To view your drafted cards later:</h2>
  <p>You can either:</p>
  <ul>
    <li>View your .ydk file on <a href="https://yugiohdeck.github.io/">https://yugiohdeck.github.io/</a>.</li>
    <li>Add your .csv file to a virtual collection on <a href="https://db.ygoprodeck.com/collection/">https://db.ygoprodeck.com/collection/</a>. Important note: if you have any duplicates, you have to manually edit the csv to have "cardq" be 2 or 3. To import it, go that page and make an account. After that, click this circled icon: <img src="public/images/import_csv.png"></img></li>
  </ul>
  <!--TODO: Replace with footer partial-->
  <footer>  
    <nav>
      <ul>
        <li><a href="https://discord.gg/kvUF4QfCZ9">Chaos Draft Discord</a></li>
        <li><a href="https://github.com/ek488/ygo_limited">GitHub</a></li>
      </ul>
    </nav>
  </footer>
</body>

</html>
