<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Chaos Draft</title>
  <link rel="icon" type="image/x-icon" href="public/images/phantom_of_chaos.png">
  <link rel="stylesheet" type="text/css" href="public/styles/all.css" media="all">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js">
  </script>
</head>

<body>
  <script>
    window.onbeforeunload = function() {
      return true; // Prevents accidental navigation away
    };
    $.ajaxSetup({
      async: false
    });

    // TODO: Remove "Draft Complete!"
    const PACKS = ["Legend of Blue Eyes White Dragon", "Metal Raiders", "Magic Ruler", "Pharaoh's Servant", "Labyrinth of Nightmare", "Legacy of Darkness", "Pharaonic Guardian", "Magician's Force", "Dark Crisis", "Invasion of Chaos", "Ancient Sanctuary", "Soul of the Duelist", "Rise of Destiny", "Flaming Eternity", "The Lost Millennium", "Cybernetic Revolution", "Elemental Energy", "Shadow of Infinity", "Enemy of Justice", "Power of the Duelist", "Cyberdark Impact", "Strike of Neos", "Force of the Breaker", "Tactical Evolution", "Gladiator's Assault", "Phantom Darkness", "Light of Destruction", "The Duelist Genesis", "Crossroads of Chaos", "Crimson Crisis", "Raging Battle", "Ancient Prophecy", "Stardust Overdrive", "Absolute Powerforce", "The Shining Darkness", "Duelist Revolution", "Starstrike Blast", "Storm of Ragnarok", "Extreme Victory", "Generation Force", "Photon Shockwave", "Order of Chaos", "Galactic Overlord", "Return of the Duelist", "Abyss Rising", "Cosmo Blazer", "Lord of the Tachyon Galaxy", "Judgment of the Light", "Shadow Specters", "Legacy of the Valiant", "Primal Origin", "Duelist Alliance", "The New Challengers", "Secrets of Eternity", "Crossed Souls", "Clash of Rebellions", "Dimension of Chaos", "Breakers of Shadow", "Shining Victories", "The Dark Illusion", "Invasion: Vengeance", "Raging Tempest", "Maximum Crisis", "Code of the Duelist", "Circuit Break", "Extreme Force", "Flames of Destruction", "Cybernetic Horizon", "Soul Fusion", "Savage Strike", "Dark Neostorm", "Rising Rampage", "Chaos Impact", "Ignition Assault", "Eternity Code", "Rise of the Duelist", "Phantom Rage", "Blazing Vortex", "Lightning Overdrive", "Dawn of Majesty", "Pendulum Evolution", "Fists of the Gadgets", "Duel Overload", "2015 Mega-Tin Mega Pack", "Legendary Duelists: White Dragon Abyss", "Legendary Duelists: Magical Hero", "Duelist Pack: Zane Truesdale", "OTS Tournament Pack 1", "Yu-Gi-Oh! The Dark Side of Dimensions Movie Pack", "Draft Complete!"];
    const NUM_OF_PACKS = PACKS.length;
    const CSV_HEADERS = [
        ["cardname", "cardq", "cardid", "cardrarity", "cardcondition", "card_edition", "cardset", "cardcode"],
      ]; // TODO: is the comma at the end necessary?
    var draftedCards = new Set();
    var chosenCard = null; // The YGOCard to be drafted.
    var cardsInPack = new Array();

    class YGOCard {
      // TODO: #cardname
      constructor(cardname, id, rarity, set, code, isExtra) {
        this.cardname = cardname; // TODO: Change cardname to cardName
        // The password printed on the bottom-left corner of the card.
        this.id = id;
        this.rarity = rarity;
        this.set = set;
        this.code = code;
         // Whether the card is an Extra Deck Monster, i.e., whether it is a 
         // Fusion, Synchro, Xyz, or Link monster
        this.isExtra = isExtra;
      }
      // TODO
      //get cardname() {
      //  return this.cardname;
      //}

      //get id() {
      //  return this.id;
      //}
    }

    // Gives an array of all the cards of a given rarity in a given pack
    function getSetlist(setname, rarity){
      var setlist = new Array();

      // Get a name in the same format as the corresponding json filename
      let formattedSetname = setname.toLowerCase().replaceAll(' ', '_')
      .replaceAll("'", "").replaceAll(":", "").replaceAll("-", "").replaceAll("!", "");

      try {
        var set_json;
        let jsonLink = "https://ek488.github.io/ygo_limited/public/json_files/set_rarity/"
        .concat(formattedSetname).concat("_").concat(rarity.toLowerCase())
        .concat(".json");

        $.getJSON(jsonLink, function(data) {
          set_json = data;
        });

        for (card in set_json.data) {
          let cardData = set_json.data[card];
          let cardType = cardData.type;

          var code;
          for (s in cardData.card_sets) {
            if (cardData.card_sets[s].set_name == setname) {
              code = cardData.card_sets[s].set_code;
            }
          }

          let isExtra = cardType == "Fusion Monster" || 
          cardType == "Synchro Monster" || 
          cardType == "Synchro Tuner Monster" || 
          cardType == "Synchro Pendulum Effect Monster" || 
          cardType == "XYZ Monster" || 
          cardType == "XYZ Pendulum Effect Monster" || 
          cardType == "Link Monster" || 
          cardType == "Pendulum Effect Fusion Monster";

          let ygoCard = new YGOCard(cardData.name, cardData.id, 
          rarity.replaceAll("_", " "), setname, code, isExtra);

          setlist.push(ygoCard);
        }
      }
      // If the set has no cards of this rarity, return null.
      catch (_) {
        setlist = null;
      }

      return setlist;
    }

    // TODO: Rework function.
    function getCommons(packListCommons, numOfCommons){
      var packCards = new Array();
      for (i = 0; i < numOfCommons; i++) {
        temp = Math.floor(Math.random() * packListCommons.length);
        packCard = packListCommons[temp];
        // Reroll the card if it's already in the pack.
        while (packCards.includes(packCard)) {
          temp = Math.floor(Math.random() * packListCommons.length);
          packCard = packListCommons[temp];
        }
        packCards.push(packCard);
      }
      return packCards;
    }

    // TODO
    function get_rare(setname, rarity){
      setlist = getSetlist(setname, rarity);
      return setlist[Math.floor(Math.random() * setlist.length)];
    }

    // TODO
    function get_pack(setname){
      var setlist = new Array();

      var pack_cards = [];
      
      var pos = PACKS.indexOf(setname);
      
      let commonSetlist = getSetlist(setname, "Common");
      var short_print_setlist = getSetlist(setname, "Short_Print");
      var super_short_print_setlist = getSetlist(setname, "Super_Short_Print");
      var temp_common_setlist = null
      if (commonSetlist != null) {
        temp_common_setlist = commonSetlist;
      }
      if (short_print_setlist != null) {
        temp_common_setlist = temp_common_setlist.concat(short_print_setlist);
      }
      if (super_short_print_setlist != null) {
        temp_common_setlist = temp_common_setlist.concat(super_short_print_setlist);
      }

      // booster_pack_old
      if (pos <= 22) {
        r = Math.floor(Math.random() * 1380) + 1;
        // TODO: generalize
        if (r <= 929) { // ~0.6731
          console.log("8 commons, 1 rare");
          // 8 Commons
          pack_cards = getCommons(temp_common_setlist, 8);
          // 1 Rare
          pack_cards.push(get_rare(setname, "Rare"));
        }
        else if (r >= 930 && r <= 1205) { // 0.2
          console.log("7 commons, 1 rare, 1 super rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          pack_cards.push(get_rare(setname, "Rare"));
          // 1 Super Rare
          pack_cards.push(get_rare(setname, "Super_Rare"));
        }
        else if (r >= 1206 && r <= 1320) { // ~0.08333
          console.log("7 commons, 1 rare, 1 ultra rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          pack_cards.push(get_rare(setname, "Rare"));
          // 1 Ultra Rare
          pack_cards.push(get_rare(setname, "Ultra_Rare"));
        }
        else { // ~0.04347
          console.log("7 commons, 1 rare, 1 secret or ultimate rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          pack_cards.push(get_rare(setname, "Rare"));
          // 1 Secret or Ultimate Rare
          var secret_setlist = getSetlist(setname, "Secret_Rare");
          var ultimate_setlist = getSetlist(setname, "Ultimate_Rare");
          var sr_ur_setlist = new Array();
          if (secret_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(secret_setlist);
          }
          if (ultimate_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(ultimate_setlist);
          }
          var pack_card = sr_ur_setlist[Math.floor(Math.random() * sr_ur_setlist.length)];
        
          // Reroll the ultimate rare if it's the same as the rare.
          while (pack_cards.includes(pack_card)) {
            temp = Math.floor(Math.random() * sr_ur_setlist.length);
            pack_card = sr_ur_setlist[temp];
          }
          pack_cards.push(pack_card);
        }
        return pack_cards;
      }
      // booster_pack_old_with_ghost_rare
      else if (pos >= 23 && pos <= 56) {
        r = Math.floor(Math.random() * 1380) + 1;
        // TODO: generalize
        if (r <= 924) {
          console.log("8 commons, 1 rare");
          // 8 Commons
          pack_cards = getCommons(temp_common_setlist, 8);
          // 1 Rare
          pack_cards.push(get_rare(setname, "Rare"));
        }
        else if (r >= 925 && r <= 1200) {
          console.log("7 commons, 1 rare, 1 super rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          pack_cards.push(get_rare(setname, "Rare"));
          // 1 Super Rare
          pack_cards.push(get_rare(setname, "Super_Rare"));
        }
        else if (r >= 1201 && r <= 1315) {
          console.log("7 commons, 1 rare, 1 ultra rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = getSetlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Ultra Rare
          var ultra_setlist = getSetlist(setname, "Ultra_Rare");
          pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        }
        else if (r >= 1316 && r <= 1375) {
          console.log("7 commons, 1 rare, 1 secret or ultimate rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = getSetlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Secret or Ultimate Rare
          var secret_setlist = getSetlist(setname, "Secret_Rare");
          var ultimate_setlist = getSetlist(setname, "Ultimate_Rare");
          var sr_ur_setlist = new Array();
          if (secret_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(secret_setlist);
          }
          if (ultimate_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(ultimate_setlist);
          }
          pack_cards.push(sr_ur_setlist[Math.floor(Math.random() * sr_ur_setlist.length)]);
        }
        else {
          console.log("7 commons, 1 rare, 1 ghost rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = getSetlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Ghost Rare
          var ghost_setlist = getSetlist(setname, "Ghost_Rare");
          pack_cards.push(ghost_setlist[Math.floor(Math.random() * ghost_setlist.length)]);
        }
        return pack_cards;
      }
      // booster_pack
      else if (pos >= 57 && pos <= 70) {
        r = Math.floor(Math.random() * 12) + 1;
        // TODO: generalize
        if (r <= 9) {
          console.log("7 commons, 1 rare, 1 super rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = getSetlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Super Rare
          var super_setlist = getSetlist(setname, "Super_Rare");
          pack_cards.push(super_setlist[Math.floor(Math.random() * super_setlist.length)]);
        }
        else if (r >= 10 && r <= 11) {
          console.log("7 commons, 1 rare, 1 ultra rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = getSetlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Ultra Rare
          var ultra_setlist = getSetlist(setname, "Ultra_Rare");
          pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        }
        else {
          console.log("7 commons, 1 rare, 1 secret or ultimate rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = getSetlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Secret or Ultimate Rare
          var secret_setlist = getSetlist(setname, "Secret_Rare");
          var ultimate_setlist = getSetlist(setname, "Ultimate_Rare");
          var sr_ur_setlist = new Array();
          if (secret_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(secret_setlist);
          }
          if (ultimate_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(ultimate_setlist);
          }
          pack_cards.push(sr_ur_setlist[Math.floor(Math.random() * sr_ur_setlist.length)]);
        }
        return pack_cards;
      }
      // booster_pack_with_starlight_rare
      else if (pos >= 71 && pos <= 73) {
        r = Math.floor(Math.random() * 576) + 1;
        // TODO: generalize
        if (r <= 432) {
          console.log("7 commons, 1 rare, 1 super rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = getSetlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Super Rare
          var super_setlist = getSetlist(setname, "Super_Rare");
          pack_cards.push(super_setlist[Math.floor(Math.random() * super_setlist.length)]);
        }
        else if (r >= 433 && r <= 528) {
          console.log("7 commons, 1 rare, 1 ultra rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = getSetlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Ultra Rare
          var ultra_setlist = getSetlist(setname, "Ultra_Rare");
          pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        }
        else if (r >= 529 && r <= 575) {
          console.log("7 commons, 1 rare, 1 secret or ultimate rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = getSetlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Secret or Ultimate Rare
          var secret_setlist = getSetlist(setname, "Secret_Rare");
          var ultimate_setlist = getSetlist(setname, "Ultimate_Rare");
          var sr_ur_setlist = new Array();
          if (secret_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(secret_setlist);
          }
          if (ultimate_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(ultimate_setlist);
          }
          pack_cards.push(sr_ur_setlist[Math.floor(Math.random() * sr_ur_setlist.length)]);
        }
        else {
          console.log("7 commons, 1 rare, 1 starlight rare");
          // 7 Commons
          pack_cards = getCommons(temp_common_setlist, 7);
          // 1 Rare
          var rare_setlist = getSetlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
          // 1 Starlight Rare
          var starlight_setlist = getSetlist(setname, "Starlight_Rare");
          pack_cards.push(starlight_setlist[Math.floor(Math.random() * starlight_setlist.length)]);
        }
        return pack_cards;
      }
      // booster_pack_without_rare_with_starlight_rare
      else if (pos >= 74 && pos <= 79) {
        r = Math.floor(Math.random() * 576) + 1;
        // TODO: generalize
        if (r <= 432) {
          console.log("8 commons, 1 super rare");
          // 8 Commons
          pack_cards = getCommons(temp_common_setlist, 8);
          // 1 Super Rare
          var super_setlist = getSetlist(setname, "Super_Rare");
          pack_cards.push(super_setlist[Math.floor(Math.random() * super_setlist.length)]);
        }
        else if (r >= 433 && r <= 528) {
          console.log("8 commons, 1 ultra rare");
          // 8 Commons
          pack_cards = getCommons(temp_common_setlist, 8);
          // 1 Ultra Rare
          var ultra_setlist = getSetlist(setname, "Ultra_Rare");
          pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        }
        else if (r >= 529 && r <= 575) {
          console.log("8 commons, 1 secret or ultimate rare");
          // 8 Commons
          pack_cards = getCommons(temp_common_setlist, 8);
          // 1 Secret or Ultimate Rare
          var secret_setlist = getSetlist(setname, "Secret_Rare");
          var ultimate_setlist = getSetlist(setname, "Ultimate_Rare");
          var sr_ur_setlist = new Array();
          if (secret_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(secret_setlist);
          }
          if (ultimate_setlist != null) {
            sr_ur_setlist = sr_ur_setlist.concat(ultimate_setlist);
          }
          pack_cards.push(sr_ur_setlist[Math.floor(Math.random() * sr_ur_setlist.length)]);
        }
        else {
          console.log("8 commons, 1 starlight rare");
          // 8 Commons
          pack_cards = getCommons(temp_common_setlist, 8);
          // 1 Starlight Rare
          var starlight_setlist = getSetlist(setname, "Starlight_Rare");
          pack_cards.push(starlight_setlist[Math.floor(Math.random() * starlight_setlist.length)]);
        }
        return pack_cards;
      }
      // pendulum_evolution (Pendulum Evolution)
      else if (pos == 80) {
        console.log("3 super rare, 2 ultra rare");
        // 3 Super Rare
        var super_setlist = getSetlist(setname, "Super_Rare");
        pack_cards = getCommons(super_setlist, 3);
        // 2 Ultra Rare
        var ultra_setlist = getSetlist(setname, "Ultra_Rare");
        pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        return pack_cards;
      }
      // 60_card_set (Fists of the Gadgets)
      else if (pos == 81) {
        // TODO: generalize
        console.log("4 super rares, 1 secret rare");
        // 4 Ultra Rares
        var super_setlist = getSetlist(setname, "Super_Rare");
        pack_cards = getCommons(super_setlist, 4);
        // 1 Secret Rare
        var secret_setlist = getSetlist(setname, "Secret_Rare");
        pack_cards.push(secret_setlist[Math.floor(Math.random() * secret_setlist.length)]);
        return pack_cards;
      }
      // duel_overload__pack (Duel Overload)
      else if (pos == 82) {
        console.log("5 ultra rares");
        // 5 Ultra Rare
        var ultra_setlist = getSetlist(setname, "Ultra_Rare");
        pack_cards = getCommons(ultra_setlist, 5);
        return pack_cards;
      }
      // mega_pack_3 (Mega Pack 2015)
      else if (pos == 83) {
        // TODO: generalize
        console.log("12 commons, 1 rare, 1 super rare, 1 ultra rare, 1 prismatic secret rare");
        // 12 Commons
        pack_cards = getCommons(temp_common_setlist, 12);
        // 1 Rare
        var rare_setlist = getSetlist(setname, "Rare");
        pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
        // 1 Super Rare
        var super_setlist = getSetlist(setname, "Super_Rare");
        pack_cards.push(super_setlist[Math.floor(Math.random() * super_setlist.length)]);
        // 1 Ultra Rare
        var ultra_setlist = getSetlist(setname, "Ultra_Rare");
        pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        // 1 Pristmatic Secret Rare
        var secret_setlist = getSetlist(setname, "Secret_Rare");
        pack_cards.push(secret_setlist[Math.floor(Math.random() * secret_setlist.length)]);
        return pack_cards;
      }
      // legendary_duelists
      else if (pos == 84 || pos == 85) {
        r = Math.floor(Math.random() * 36) + 1;
        // TODO: generalize
        if (r <= 24) {
          console.log("4 commons, 1 rare");
          // 4 Commons
          pack_cards = getCommons(temp_common_setlist, 4);
          // 1 Rare
          var rare_setlist = getSetlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
        }
        else if (r >= 25 && r <= 31) {
          console.log("4 commons, 1 super rare");
          // 4 Commons
          pack_cards = getCommons(temp_common_setlist, 4);
          // 1 Super Rare
          var super_setlist = getSetlist(setname, "Super_Rare");
          pack_cards.push(super_setlist[Math.floor(Math.random() * super_setlist.length)]);
        }
        else {
          console.log("4 commons, 1 ultra rare");
          // 4 Commons
          pack_cards = getCommons(temp_common_setlist, 4);
          // 1 Ultra Rare
          var ultra_setlist = getSetlist(setname, "Ultra_Rare");
          pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        }
        return pack_cards;
      }
      // duelist_pack (Duelist Pack 4: Zane Truesdale)
      else if (pos == 86) {
        r = Math.floor(Math.random() * 12) + 1;
        if (r <= 8) {
          console.log("4 commons, 1 rare");
          // 4 Commons
          pack_cards = getCommons(temp_common_setlist, 4);
          // 1 Rare
          var rare_setlist = getSetlist(setname, "Rare");
          pack_cards.push(rare_setlist[Math.floor(Math.random() * rare_setlist.length)]);
        }
        else if (r >= 9 && r <= 11) {
          console.log("4 commons, 1 super rare");
          // 4 Commons
          pack_cards = getCommons(temp_common_setlist, 4);
          // 1 Super Rare
          var super_setlist = getSetlist(setname, "Super_Rare");
          pack_cards.push(super_setlist[Math.floor(Math.random() * super_setlist.length)]);
        }
        else {
          console.log("4 commons, 1 ultra rare");
          // 4 Commons
          pack_cards = getCommons(temp_common_setlist, 4);
          // 1 Ultra Rare
          var ultra_setlist = getSetlist(setname, "Ultra_Rare");
          pack_cards.push(ultra_setlist[Math.floor(Math.random() * ultra_setlist.length)]);
        }
        return pack_cards;
      }
      // ots_tournament_pack (OTS Tournament Pack 1)
      else if (pos == 87) {
        r = Math.floor(Math.random() * 17) + 1;
        if (r <= 16) {
          console.log("2 commons, 1 super rare");
          // 2 Commons
          pack_cards = getCommons(temp_common_setlist, 2);
          // 1 Super Rare
          var super_setlist = getSetlist(setname, "Super_Rare");
          pack_cards.push(super_setlist[Math.floor(Math.random() * super_setlist.length)]);
        }
        else {
          console.log("2 commons, 1 ultimate rare");
          // 2 Commons
          pack_cards = getCommons(temp_common_setlist, 2);
          // 1 Ultimate  Rare
          var ultimate_setlist = getSetlist(setname, "Ultimate_Rare");
          pack_cards.push(ultimate_setlist[Math.floor(Math.random() * ultimate_setlist.length)]);
        }
        return pack_cards;
      }
      // the_dark_side_of_dimensions_movie_pack (Yu-Gi-Oh! The Dark Side of Dimensions Movie Pack)
      else {
        console.log("5 ultra rares");
        // 5 Ultra Rare
        var ultra_setlist = getSetlist(setname, "Ultra_Rare");
        pack_cards = getCommons(ultra_setlist, 5);
        return pack_cards;
      }
    }

    function display_card_image(card, is_pack_card=false, r=null){
      cardID = card.id
      cardName = card.cardname
      var x = document.createElement("IMG");
      x.setAttribute("src", "public/images/card_images/".concat(cardID).concat(".jpg"));
      x.setAttribute("alt", cardID);
      if (cardName != null) {
        x.setAttribute("title", cardName);
      }
      if (cardsInPack.length <= 10 & is_pack_card) {
        x.setAttribute("height", 301);
        x.setAttribute("width", 206);
      }
      else if (cardsInPack.length > 10 & cardsInPack.length <= 15 & is_pack_card) {
        x.setAttribute("height", 242);
        x.setAttribute("width", "auto");
      }
      else if (cardsInPack.length > 15 & is_pack_card) {
        x.setAttribute("height", 197);
        x.setAttribute("width", "auto");
      }
      else
      {
        x.setAttribute("height", 156);
        x.setAttribute("width", "auto");
      }
      if (is_pack_card) {
        var rarity = document.createElement("P");
        rarity.innerHTML = r
        rarity.setAttribute("class", "rarity");

        var dv = document.createElement("DIV");
        dv.setAttribute("class", "div");
        dv.setAttribute("style", "display:inline-block");

        x.setAttribute("class", "pack ".concat(cardID));

        x.setAttribute("onclick", "choose_card('".concat(String(cardID)).concat("', '").concat("')"));

        document.getElementById("pack").appendChild(dv);
        dv.appendChild(x); //
        dv.appendChild(rarity);
      }
      else {
        document.body.insertBefore(x, document.getElementById("download_break"));
      }
      //var y = document.createElement("IMG");
      //y.setAttribute("src", "public/images/card_images/".concat(id).concat(".jpg"));
      //y.setAttribute("class", "hover");
      //y.setAttribute("z-index", 1);
    }

    // Show a border around the last selected card in the pack.
    function choose_card(id){
      // Remove the border from all cards in the pack.
      for (pack_card_img of document.getElementsByClassName("pack")) {
        pack_card_img.style.border = "8px solid transparent";
      }

      // If the clicked card had a border already, don't add a border.
      try {
        var chosenID = chosenCard.id;
        if (chosenID != id) {
          chosenID = id;
          for (card in cardsInPack) {
            if (cardsInPack[card].id == id) {
              chosenCard = cardsInPack[card];
            }
          }
          for (pack_card_img of document.getElementsByClassName(id)) {
            pack_card_img.style.border = "8px solid green";
          }
        }
        else {
          chosenID = null;
          chosenCard = null;
        }
      } catch (_) {
        var chosenID = id;
        for (card in cardsInPack) {
          if (cardsInPack[card].id == id) {
            chosenCard = cardsInPack[card];
          }
        }
        for (pack_card_img of document.getElementsByClassName(id)) {
          pack_card_img.style.border = "8px solid green";
        }
      }

    }

    // TODO: change hidden to display: none
    function draft(){
      if (chosenCard.id != null) {
        draftedCards.add(chosenCard);
        display_card_image(chosenCard);

        numDrafted = draftedCards.size;

        // Update number of cards drafted
        document.getElementById("setHeader").innerHTML = PACKS[numDrafted]; // Update the set name in the header
        document.getElementById("deckHeader").innerHTML = "Drafted Cards (".concat(numDrafted.toString()).concat("/").concat(NUM_OF_PACKS - 1).concat(")");

        chosenCard = null;

        for (pack_card_img of document.getElementsByClassName("pack")) {
          pack_card_img.display = "none";
        }
        for (rrty of document.getElementsByClassName("rarity")) {
          rrty.style.display = "none";
        }
        for (dv of document.getElementsByClassName("div")) {
          dv.style.display = "none";
        }

        if (numDrafted < NUM_OF_PACKS) {
          cardsInPack = get_pack(PACKS[numDrafted]);
          for (pack_card of cardsInPack) {
            display_card_image(pack_card, true, pack_card.rarity);
          }
        }
      }
    }
    
    function download_csv_collection(){
      var rows = CSV_HEADERS;
      var deck_cards = Array.from(draftedCards);

      // TODO: Change to const?
      let characterArray = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z', '0', '1', '2', '3', '4', '5', '6', '7', '8', '9']
      // TODO: Change to const?
      let numOfCharacters = characterArray.length;
      for (card_number in deck_cards){
        card = deck_cards[card_number];
        var cardname = card.cardname;
        // If CARDNAME has a comma, surround CARDNAME with quotation marks
        if (cardname.includes(",")) {
          cardname = '"'.concat(cardname).concat('"');
        }
        var rarity = card.rarity;
        if (card.rarity == "Short Print" || card.rarity == "Super Short Print") {
          rarity = "Common";
        }

        // Make a random cardcode
        cardcode = ""
        // Four random characters
        cardcode = cardcode + characterArray[Math.floor(Math.random() * numOfCharacters)] + characterArray[Math.floor(Math.random() * numOfCharacters)] + characterArray[Math.floor(Math.random() * numOfCharacters)] + characterArray[Math.floor(Math.random() * numOfCharacters)]
        cardcode = cardcode + '-'
        // Six random characters
        cardcode = cardcode + characterArray[Math.floor(Math.random() * numOfCharacters)] + characterArray[Math.floor(Math.random() * numOfCharacters)] + characterArray[Math.floor(Math.random() * numOfCharacters)] + characterArray[Math.floor(Math.random() * numOfCharacters)] + characterArray[Math.floor(Math.random() * numOfCharacters)] + characterArray[Math.floor(Math.random() * numOfCharacters)]

        rows.push([cardname, "1", card.id, rarity, "M", "Unlimited", card.set, cardcode])
      }

      var csvContent = "";
      
      rows.forEach(function(rowArray) {
        let row = rowArray.join(",");
        csvContent += row + "\r\n";
      });

      var encodedUri = encodeURIComponent("\uFEFF" + csvContent);
      var link = document.createElement("a");
      link.setAttribute("href", "data:text/csv;charset=utf-8," + encodedUri);
      link.setAttribute("download", "chaos_collection.csv");
      document.body.appendChild(link);

      link.click();
    }

    function download_ydk(){
      var deck_cards = Array.from(draftedCards);
      var ydk = "#created by ...\n#main"
      var extra = ""

      for (card in deck_cards) {
        if (!deck_cards[card].isExtra) {
          ydk = ydk.concat("\n").concat(deck_cards[card].id);
        }
        else {
          extra = extra.concat("\n").concat(deck_cards[card].id);
        }
      }
      var text = ydk.concat("\n#extra").concat(extra);

      var ydk_download = document.createElement("a");
      ydk_download.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text))
      ydk_download.setAttribute('download', "chaos.ydk")
      ydk_download.style.display = 'none';
      document.body.appendChild(ydk_download);

      ydk_download.click();
    };
  </script>

  <h1 id="setHeader"><script>document.write(PACKS[0])</script></h1>
  <div id="pack"></div>

  <!--TODO: Replace with padding or 
    span + span {
    margin-left: 1px;
}
-->
  <br id="break">
  <br>

  <div style="text-align: center;">
    <button id="draftButton" type="button" onclick="draft()">Draft Selected Card</button>
  </div>
  <h1 id="deckHeader">Drafted Cards (0/<script>document.write(NUM_OF_PACKS - 1)</script>)</h1>

  <!--TODO: Replace with padding or 
  span + span {
  margin-left: 1px;
}
-->
  <br id="download_break">
  <br>
  <button type="button" onclick="download_csv_collection()">Download .csv file</button>
  <button type="button" onclick="download_ydk()">Download .ydk file</button>
  <script>
    cardsInPack = get_pack(PACKS[draftedCards.size]);
    for (pack_card of cardsInPack) {
      display_card_image(pack_card, true, pack_card.rarity);
    }
  </script>
  <h2>To view your drafted cards later:</h2>
  <ul>
    <li>You can add your .csv file to a virtual collection on <a href="https://db.ygoprodeck.com/collection/">https://db.ygoprodeck.com/collection/</a>. To import it, go that page and make an account. After that, click this circled icon: <img src="public/images/import_csv.png" alt='The location of the "Upload .CSV/.YDK file" is circled.'></li>
    <li>You can view your .ydk file on <a href="https://ygoprodeck.com/card-database/deck-prices/">https://ygoprodeck.com/card-database/deck-prices/</a>, <a href="https://yugiohdeck.github.io/">https://yugiohdeck.github.io/</a>, or EDOPro. Important note: do NOT import your .ydk file to your YGOPRODeck collection, as it will overwrite any duplicate cards you drafted.</li>
  </ul>
  <p>
    Last updated: 10 February 2023
  </p>
  <footer>
    <nav>
      <ul>
        <li><a href="https://discord.gg/kvUF4QfCZ9">Chaos Draft Discord</a></li>
        <li><a href="chaos.html">Chaos Draft Simulator</a></li>
        <li><a href="custom_chaos.html">Custom Chaos Draft Simulator</a></li>
        <li><a href="custom_chaos_pack.html">Custom Chaos Single Pack Draft</a></li>
        <li><a href="progression.html">Progression Series Simulator</a></li>
      </ul>
    </nav>
  </footer>
</body>

</html>
